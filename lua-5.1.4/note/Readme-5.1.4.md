# Lua-5.1.4

> 参考《Lua设计与实现》

## 文件列表及其定义

1. 虚拟机核心相关文件列表

| 文件名          | 作用               | 对外接口前缀  |
| ------------ | ---------------- | ------- |
| *lapi.c*     | C语言接口            | `lua_`  |
| *lcode.c*    | 源码生成器            | `luaK_` |
| *ldebug*     | 调试库              | `luaG_` |
| *ldo.c*      | 函数调用及栈管理         | `luaD_` |
| *ldump.o*    | 序列化预编译的Lua字节码    |         |
| *lfunc.c*    | 提供操作函数原型及闭包的辅助函数 | `luaF_` |
| *lgc.c*      | GC               | `luaC_` |
| *llex.c*     | 词法分析             | `luaX_` |
| *lmem.c*     | 内存管理             | `luaM_` |
| *lobject.c*  | 对象管理             | `luaO_` |
| *lopcodes.c* | 字节码操作            | `luaP_` |
| *lparser.c*  | 分析器              | `luaY_` |
| *lstate.c*   | 全局状态机            | `luaE_` |
| *lstring.c*  | 字符串操作            | `luaS_` |
| *ltable.c*   | 表操作              | `luaH_` |
| *lundump.c*  | 加载预编译字节码         | `luaU_` |
| *ltm.c*      | tag方法            | `luaT_` |
| *lzio.c*     | 缓存流接口            | `luaZ_` |

2. 内嵌库相关文件列表

| 文件名          | 作用             |
| ------------ | -------------- |
| *lauxlib.c*  | 库编写时需要用到的辅助函数库 |
| *lbaselib.c* | 基础库            |
| *ldblib.c*   | 调试库            |
| *liolib.c*   | IO库            |
| *lmathlib.c* | 数学库            |
| *loslib.c*   | OS库            |
| *ltablib.c*  | 表操作库           |
| *lstrlib.c*  | 字符串操作库         |
| *loadlib.c*  | 动态拓展库加载器       |
| *linit.c*    | 负责内嵌库的初始化      |

3. 解析器、字节码编译器相关文件列表

| 文件名      | 作用     |
| -------- | ------ |
| *lua.c*  | 解释器    |
| *luac.c* | 字节码编译器 |

## Lua虚拟机工作流程

Lua代码是通过翻译成Lua虚拟机能识别的字节码运行的。

- **翻译代码以及编译为字节码的部分**。这部分代码负责将Lua代码进行词法分析、语法分析等，最终生成字节码。析等，最终生成字节码。涉及这部分的代码文件包括*llex.c*(用于进行词法分析)和*lparser.c*(用于进行语法分析)，而最终生成的代码则使用了*lcode.c*文件中的功能。在*lopcodes.h*、*lopcodes.c*文件中，则定义了Lua虚拟机相关的字节码指令的格式以及相关的API。

- **Lua虚拟机相关的部分**。在第一步中，经过分析阶段之后，生成了对应的字节码，第二步就是将这些字节码装载到虚拟机中执行。Lua虚拟机相关的代码在*lvm.c*中，虚拟机执行的主函数是`luaV_execute`，不难想象这个函数是一个大的循环，依次从字节码中取出指令并执行。Lua虚拟机对外看到的数据结构是`lua_State`，这个结构体将一直贯穿整个分析以及执行阶段。除了虚拟机的执行外，Lua的核心部分还包括了进行函数调用和返回处理的相关代码，主要处理函数调用前后环境的准备和还原，这部分代码在*ldo.c*中，垃圾回收部分的代码在*lgc.c*中。Lua是一门嵌入式的脚本语言，这意味着它的设计目标之一必须满足能够与宿主系统进行交互，这部分代码在*lapi.c*中。
